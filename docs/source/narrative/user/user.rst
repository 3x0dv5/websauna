========================
User, log in and sign up
========================

.. contents :: local:

Websauna has a subsystem for user management.

* Pyramid authentication is used for authenticating users

* Default SQLAlchemy models are provided for users and groups through Horus

* Default Bootstrap templates for log in, sign up and other related forms are available

* :term:`Authomatic` is used for social logins: Facebook, Twitter, Github and other OAuth-based systems. :doc:`This is covered in another chapter <./oauth>`_.

User services
=============

Login and sign up process consists of different services which are registered as components in :py:meth:`websauna.system.Initializer.configure_user_models`. Each of the services can be individually overridden and customizer.

Default user model
------------------

The default user model is :py:class:`websauna.system.user.models.User`. It is good for basic site bootstrapping, but eventualy you want to extend it for your own purposes.

All users are signed up and logged in via email/password. There is a ``username`` field, but it is autogenerated default. If you are building e.g. a forum and wish to users choose their own usernames you can edit this field in profile or ask on the sign up form. Also this model is easier to adopt users for external sources, like Facebook.

The most important attributes of the default model are

* ``friendly_name`` - this property tries to give out the most friendlist choice from full name, email username

* ``full_name`` - human name of the user

* ``id`` - human readable id, visible only for admins - never expose this to the site visitors

* ``uuid`` - randomized id, user all over the public site

* ``user_data`` - JSONB dictionary, can hold any arbitrary data

* ``activation`` - any pending :py:`websauna.system.user.model.Activation` token for email activation, password reset

Abstract user registry
----------------------

:py:class:`websauna.system.user.userregistry.DefaultEmailBasedUserRegistry` maintains users in the database. By default this is done by using a :term:`SQLAlchemy` model :py:class:`:websauna.system.user.userregistry.DefaultEmailBasedUserRegistry`. ``UserRegistry`` users can be based on anything - you can store users in LDAP, Cassandra, you-name-it.

Creating your own user class
----------------------------

If you just want to roll your own SQLAlchemy model for the user, you can do it by overriding :py:meth:`websauna.system.Initializer.configure_user_models`. and registering your own::

    def configure_user_models(self):
        # ... lot of copy paste from parent function ...

        from websauna.system.user.interfaces import IUserModel

        registry = self.config.registry
        registry.registerUtility(myapp.models.User, IUserModel)
        # ... lot of copy paste from parent function ...

This assumes the model is compatible with the default site user flow and has attributes like ``user.email`` and ``user.password``. It is safe to inherit from the base :py:class:`websauna.system.user.usermixin.UserMixin` if you are not building user system from the scratch.

Login service
-------------

Login service is responsible for email/password and username/password logins. Unlike other related services, the login service must have knowledge of user model internals.

See :py:class:`websauna.system.user.loginservice.DefaultLoginService`.

You can override this in :py:meth:`websauna.system.Initializer.configure_user`.

Default views are found in :py:mod:`websauna.system.user.views`.

Registration service
--------------------

Registration service is responsible for users created through sign up form.

See :py:class:`websauna.system.user.registrationservice.DefaultRegistrationService`.

You can override this in :py:meth:`websauna.system.Initializer.configure_user`.

Default views are found in :py:mod:`websauna.system.user.views`.

Credential activity service
---------------------------

Credential activity service is responsible for password reset requests.

See :py:class:`websauna.system.user.credentialactivityservice.DefaultCredentialActivityService`.

You can override this in :py:meth:`websauna.system.Initializer.configure_user`.

Default views are found in :py:mod:`websauna.system.user.views`.

Groups
======

The default user implementation has groups. User can be member of any number of groups.

`Pyramid ACL <http://docs.pylonsproject.org/projects/pyramid/en/latest/tutorials/wiki/authorization.html>`_ is used to assign permissions for groups.

Events
======

Various events are fired during the user sign up and log in.

See

* :py:mod:`websauna.system.user.events`

* :py:mod:`horus.events`

Advanced
========

Horus legacy
------------

.. note ::

    Currently there are various references to Horus package internally, but they are expected to cleaned up in the future versions.


Generating test users
---------------------

Below is a simple shell script to generate empty users for manual testing purposes::

    from websauna.system.user.utils import get_user_class

    # Get instance of whatever user class is configured for Websauna
    User = get_user_class(registry)

    for i in range(0, 100):
        username = "u{}".format(i)
        email = "dummy{}@example.com".format(i)
        password = "x"
        user = User(username=username, email=email, password=password)
        user.user_registration_source = User.USER_MEDIA_DUMMY
        DBSession.add(user)

    transaction.commit()


Getting all users who are members of a group
--------------------------------------------

Example::

    admin_group = DBSession.query(Group).filter_by(name="admin").first()
    users = admin_group.users